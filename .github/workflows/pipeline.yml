name: MLB daily update & retrain

on:
  workflow_dispatch:   # allow manual runs
  schedule:
    # GitHub cron is UTC. 17:15 UTC ≈ 9:15 AM Pacific (standard time).
    - cron: "15 17 * * *"

jobs:
  update-train:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          # Do NOT set cache or cache-dependency-path since we don't have requirements.txt yet

      # ---------- Dependencies ----------
      - name: Install deps (use requirements.txt if present, else fallback)
        run: |
          set -e
          python -m pip install --upgrade pip

          if [ -f "requirements.txt" ]; then
            echo "Found requirements.txt — installing from it..."
            pip install -r requirements.txt
          else
            echo "No requirements.txt found — installing fallback packages..."
            pip install \
              numpy \
              pandas \
              matplotlib \
              scikit-learn \
              xgboost \
              lightgbm \
              catboost \
              statsmodels \
              requests \
              tqdm \
              pybaseball \
              statsapi
          fi

      # ---------- Your pipeline ----------
      - name: Ingest latest games
        run: |
          python scripts/data_ingest.py --year 2025 --backfill-days 35 --only-ingest

      - name: Prepare features
        run: |
          python scripts/prepare_features.py --in out/raw_games.csv --out out/mlb_features_prepared.csv

      - name: Train / retrain model
        run: |
          python scripts/model_train_allinone.py \
            --data "out/mlb_features_prepared.csv" \
            --date-col game_date \
            --id-col game_pk \
            --target home_win \
            --outdir "model_all_ts" \
            --topk 25 \
            --threshold-strategy f1 \
            --add-rolling \
            --add-interactions \
            --calibration isotonic \
            --walkforward ts \
            --n-splits 6

      - name: Commit results (if changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "CI: ingest + feature prep + retrain (auto)"
            git push
          fi

      # ---------- Email alerts ----------
      - name: Send success email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          secure: true
          from: ${{ secrets.ALERT_FROM }}
          to: ${{ secrets.ALERT_TO }}
          subject: "✅ MLB pipeline SUCCESS — ${{ github.repository }} #${{ github.run_number }}"
          html_body: |
            <h2>MLB pipeline run succeeded</h2>
            <ul>
              <li><b>Repo:</b> ${{ github.repository }}</li>
              <li><b>Run ID:</b> ${{ github.run_id }}</li>
              <li><b>Branch:</b> ${{ github.ref_name }}</li>
              <li><b>Commit:</b> ${{ github.sha }}</li>
              <li><b>Timestamp (UTC):</b> ${{ github.run_started_at }}</li>
            </ul>
            <p>Artifacts and model outputs were committed if there were changes.</p>

      - name: Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          secure: true
          from: ${{ secrets.ALERT_FROM }}
          to: ${{ secrets.ALERT_TO }}
          subject: "❌ MLB pipeline FAILED — ${{ github.repository }} #${{ github.run_number }}"
          html_body: |
            <h2>MLB pipeline run failed</h2>
            <ul>
              <li><b>Repo:</b> ${{ github.repository }}</li>
              <li><b>Run ID:</b> ${{ github.run_id }}</li>
              <li><b>Branch:</b> ${{ github.ref_name }}</li>
              <li><b>Commit:</b> ${{ github.sha }}</li>
              <li><b>Timestamp (UTC):</b> ${{ github.run_started_at }}</li>
            </ul>
            <p>Check the Actions logs for the failing step.</p>

