name: MLB daily update & retrain

on:
  workflow_dispatch: {}
  schedule:
    # 17:15 UTC â‰ˆ 9:15 AM Pacific (Standard Time)
    - cron: "15 17 * * *"

permissions:
  contents: write

jobs:
  update-train:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"
      MPLBACKEND: "Agg"     # headless plots
      PIP_DISABLE_PIP_VERSION_CHECK: "1"

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install deps (use requirements.txt if present, else fallback)
        shell: bash
        run: |
          python -V
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install \
              numpy pandas matplotlib scikit-learn xgboost lightgbm catboost \
              statsmodels requests tqdm pybaseball statsapi
          fi

      - name: Ensure output folders
        run: |
          mkdir -p out
          mkdir -p out/model_all_ts

      # ---------- YOUR PIPELINE ----------

      - name: Ingest latest games
        shell: bash
        run: |
          # Adjust this command if your ingest script/flags differ.
          python scripts/ingest_games.py --out out/raw_games.csv

      - name: Prepare features
        shell: bash
        run: |
          # FIX: use --data (not --in) to match argparse in prepare_features.py
          python scripts/prepare_features.py \
            --data out/raw_games.csv \
            --out out/mlb_features_prepared.csv \
            --date-col game_date \
            --id-col game_pk \
            --target home_win

      - name: Train / retrain model
        shell: bash
        run: |
          # Linux paths; quotes not required
          python scripts/model_train_allinone.py \
            --data out/mlb_features_prepared.csv \
            --date-col game_date \
            --id-col game_pk \
            --target home_win \
            --outdir out/model_all_ts \
            --topk 25 \
            --threshold-strategy f1 \
            --add-rolling \
            --add-interactions \
            --calibration isotonic \
            --walkforward ts \
            --n-splits 6

      # ---------- OUTPUTS ----------

      - name: Upload artifacts (features + models + plots)
        uses: actions/upload-artifact@v4
        with:
          name: mlb-training-output
          path: |
            out/mlb_features_prepared.csv
            out/model_all_ts/**
          if-no-files-found: warn

      # Optional: commit results back to main (disable if you don't want repo churn)
      - name: Commit updated outputs back to main
        if: ${{ github.ref == 'refs/heads/main' }}
        shell: bash
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Only add if something actually changed
          git add out/mlb_features_prepared.csv out/model_all_ts || true
          if ! git diff --cached --quiet; then
            git commit -m "CI: update features & models [skip ci]"
            git push origin HEAD:main
          else
            echo "No changes to commit."
          fi



