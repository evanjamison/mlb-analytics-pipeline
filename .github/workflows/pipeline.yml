name: pipeline

on:
  workflow_dispatch:
  push:
    branches: [main, master]
  schedule:
    - cron: '15 8 * * *'  # optional
permissions:
  contents: read

jobs:
  train:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -U pip
          if [[ -f requirements.txt ]]; then
            pip install -r requirements.txt
          else
            pip install \
              "numpy>=1.22" "pandas>=2.0" "matplotlib>=3.8" \
              "scikit-learn>=1.3" "xgboost>=2.0" "lightgbm>=4.2" \
              "catboost>=1.2" "statsmodels>=0.14" \
              "mlbstatsapi>=1.7.1" "pybaseball>=2.2" "requests>=2.31"
          fi

      - name: Run orchestrator (run_pipeline.py) or fallback to manual build/train
        shell: bash
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          set -euo pipefail

          if [[ -f scripts/run_pipeline.py ]]; then
            echo ">> scripts/run_pipeline.py detected - running orchestrator"
            python scripts/run_pipeline.py \
              --pybin python \
              --base-year 2024 \
              --run-eda \
              --add-rolling \
              --add-interactions
          else
            echo ">> No orchestrator found - manual flow"
            mkdir -p out

            # Raw fallback features (very slim) - only if prepare/model need something to chew on
            python - <<'PY'
            import os
            import pandas as pd

            RAW = "out/raw_games.csv"
            if not os.path.exists(RAW):
                raise SystemExit("No raw_games.csv - cannot fallback. Add scripts/run_pipeline.py instead.")

            df = pd.read_csv(RAW)
            keep = ['game_date','game_pk','home_win']
            df = df[[c for c in keep if c in df.columns]]
            df.to_csv("out/mlb_features_combined.csv", index=False)
            print("[fallback] wrote out/mlb_features_combined.csv")
            PY

            # EDA (best-effort)
            if [[ -f scripts/eda_scaffold.py ]]; then
              python scripts/eda_scaffold.py \
                --data "out/mlb_features_combined.csv" \
                --date-col game_date --id-col game_pk --target home_win || true
            fi

            # Prepare
            python scripts/prepare_features.py \
              --data "out/mlb_features_combined.csv" \
              --out "out/mlb_features_prepared.csv" \
              --date-col game_date --id-col game_pk --target home_win

            # Train
            python scripts/model_train_allinone.py \
              --data "out/mlb_features_prepared.csv" \
              --date-col game_date --id-col game_pk --target home_win \
              --outdir "model_all_ts" --topk 25 --threshold-strategy f1 \
              --add-rolling --add-interactions \
              --calibration isotonic --walkforward monthly --n-splits 6 \
              --min-edge 0.02 --kelly-cap 0.05
          fi

