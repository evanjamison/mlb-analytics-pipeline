name: MLB daily update & retrain

on:
  workflow_dispatch: {}
  schedule:
    # 09:15 AM Pacific (Standard Time) == 17:15 UTC
    - cron: "15 17 * * *"

permissions:
  contents: write

jobs:
  update-train:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (try requirements.txt, else robust fallback)
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip setuptools wheel
          FAILED_REQ=0
          if [ -f "requirements.txt" ]; then
            if ! pip install -r requirements.txt ; then
              FAILED_REQ=1
            fi
          else
            FAILED_REQ=1
          fi
          if [ "$FAILED_REQ" = "1" ]; then
            pip install --upgrade \
              "numpy<2.2" "pandas<2.3" "matplotlib>=3.8" \
              "scikit-learn>=1.4" "xgboost>=2.0" "lightgbm>=4.0" \
              "catboost>=1.2.5" "statsmodels>=0.14" "requests>=2.31" \
              "tqdm>=4.66" pybaseball mlb-statsapi
          else
            pip install --upgrade mlb-statsapi || true
          fi

      - name: Ensure fallback feature builder exists (only used if your ingest doesn't create features)
        shell: bash
        run: |
          set -e
          mkdir -p scripts out
          if [ ! -f scripts/feature_build.py ]; then
            cat > scripts/feature_build.py <<'PY'
import os, pandas as pd, numpy as np

RAW = "out/raw_games.csv"
OUT = "out/mlb_features_prepared.csv"
DATE_COL, ID_COL, TARGET = "game_date","game_pk","home_win"

if not os.path.exists(RAW):
    raise SystemExit(f"fallback builder: {RAW} not found")

df = pd.read_csv(RAW, low_memory=False)

# Try to map common alt column names
for c in [DATE_COL, ID_COL, TARGET]:
    if c not in df.columns:
        if c=="game_date":
            for alt in ["date","gameDate","game_datetime","start_date"]:
                if alt in df.columns: DATE_COL = alt; break
        if c=="game_pk":
            for alt in ["game_id","id","gamePk"]:
                if alt in df.columns: ID_COL = alt; break
        if c=="home_win":
            for alt in ["homeWin","home_win_flag","target","label"]:
                if alt in df.columns: TARGET = alt; break

drop_sub = ("score","result","win_prob","prob","implied","moneyline",
            "odds","final","post","series","label","target","outcome")

feat=[]
for col in df.columns:
    lc = col.lower()
    if col in (DATE_COL, ID_COL, TARGET): 
        continue
    if any(s in lc for s in drop_sub): 
        continue
    if "_score" in lc or lc.endswith("_w") or lc.endswith("_l"):
        continue
    if pd.api.types.is_numeric_dtype(df[col]) and df[col].notna().any():
        feat.append(col)

keep = [DATE_COL, ID_COL, TARGET] + feat
df = df[keep].sort_values(DATE_COL).reset_index(drop=True)
df.to_csv(OUT, index=False)
print(f"[fallback] wrote {OUT} with {len(df)} rows and {len(feat)} features")
PY
          fi

      # -------------- SINGLE ORCHESTRATOR STEP --------------
      - name: Run orchestrator (run_pipeline.py) or fallback to manual build/train
        shell: bash
        run: |
          set -euo pipefail
          if [ -f "scripts/run_pipeline.py" ]; then
            echo ">> scripts/run_pipeline.py detected — running orchestrator"
            python scripts/run_pipeline.py \
              --base-year 2024 \
              --run-eda \
              --add-rolling \
              --add-interactions
          else
            echo ">> No orchestrator found — using existing manual build/train flow"
            mkdir -p out
            success=0
            if python scripts/data_ingest.py --year 2025 --backfill-days 35 --build-features --out out/mlb_features_prepared.csv 2>/dev/null; then
              success=1
            fi
            if [ $success -eq 0 ]; then
              if python scripts/data_ingest.py --year 2025 --backfill-days 35 --all --out out 2>/dev/null; then
                found="$(ls -1 out/mlb_features_*prepared*.csv 2>/dev/null | head -n1 || true)"
                if [ -n "$found" ]; then cp "$found" out/mlb_features_prepared.csv; success=1; fi
              fi
            fi
            if [ $success -eq 0 ] && [ -f out/raw_games.csv ]; then
              python scripts/feature_build.py
              success=1
            fi
            if [ $success -eq 0 ]; then
              echo "ERROR: No features CSV produced."; exit 2
            fi
            python scripts/model_train_allinone.py \
              --data "out/mlb_features_prepared.csv" \
              --date-col game_date \
              --id-col game_pk \
              --target home_win \
              --outdir "model_all_ts" \
              --topk 25 \
              --threshold-strategy f1 \
              --add-rolling \
              --add-interactions \
              --calibration isotonic \
              --walkforward ts \
              --n-splits 6
          fi

      # -------------- UPLOAD ARTIFACTS --------------
      - name: Upload artifacts (reports + datasets)
        uses: actions/upload-artifact@v4
        with:
          name: mlb-artifacts
          if-no-files-found: warn
          retention-days: 14
          path: |
            out/**
            eda_out/**/*
            eda_out_plus/**/*
            model_out/**/*
            model_all_ts/**/*

      # -------------- COMMIT RESULTS --------------
      - name: Commit results (if changed)
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "CI: ingest + feature prep + retrain (auto)"
            git push
          fi

      # -------------- EMAIL ALERTS --------------
      - name: Send success email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "✅ MLB pipeline SUCCESS — ${{ github.repository }} #${{ github.run_number }}"
          to: ${{ secrets.ALERT_TO }}
          from: ${{ secrets.ALERT_FROM }}
          secure: true
          html_body: |
            <h2>MLB pipeline run succeeded</h2>
            <ul>
              <li><b>Repo:</b> ${{ github.repository }}</li>
              <li><b>Run ID:</b> ${{ github.run_id }}</li>
              <li><b>Branch:</b> ${{ github.ref_name }}</li>
              <li><b>Commit:</b> ${{ github.sha }}</li>
              <li><b>Timestamp (UTC):</b> ${{ github.run_started_at }}</li>
            </ul>

      - name: Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "❌ MLB pipeline FAILED — ${{ github.repository }} #${{ github.run_number }}"
          to: ${{ secrets.ALERT_TO }}
          from: ${{ secrets.ALERT_FROM }}
          secure: true
          html_body: |
            <h2>MLB pipeline run failed</h2>
            <p>Check the Actions logs for the failing step.</p>
