name: MLB daily update & retrain

on:
  workflow_dispatch: {}
  schedule:
    # 9:15 AM Pacific (GitHub cron runs in UTC; 17:15 UTC = 9:15 PT in Standard Time)
    - cron: "15 17 * * *"

# 3a) Minimal permissions — we only read repo contents; no writes/pushes.
permissions:
  contents: read

concurrency:
  group: mlb-pipeline-${{ github.ref }}
  cancel-in-progress: false

jobs:
  update-train:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (try requirements.txt, else robust fallback)
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip setuptools wheel
          FAILED=0
          if [ -f requirements.txt ]; then
            if ! pip install -r requirements.txt ; then
              FAILED=1
            fi
          else
            FAILED=1
          fi
          if [ "$FAILED" = "1" ]; then
            pip install --upgrade \
              "numpy<2.2" "pandas<2.3" "matplotlib>=3.8" \
              "scikit-learn>=1.4" "xgboost>=2.0" "lightgbm>=4.0" \
              "catboost>=1.2.5" "statsmodels>=0.14" "requests>=2.31" \
              "tqdm>=4.66" pybaseball mlb-statsapi
          else
            pip install --upgrade mlb-statsapi || true
          fi

      - name: Ensure output dir
        run: mkdir -p out

      - name: Ingest latest games
        run: |
          python scripts/data_ingest.py --year 2025 --backfill-days 35 --only-ingest

      - name: Prepare features
        run: |
          python scripts/prepare_features.py \
            --data out/raw_games.csv \
            --out  out/mlb_features_prepared.csv

      - name: Train / retrain model
        shell: bash
        run: |
          python scripts/model_train_allinone.py \
            --data "out/mlb_features_prepared.csv" \
            --date-col game_date \
            --id-col game_pk \
            --target home_win \
            --outdir "model_all_ts" \
            --topk 25 \
            --threshold-strategy f1 \
            --add-rolling \
            --add-interactions \
            --calibration isotonic \
            --walkforward ts \
            --n-splits 6

      # 3b) Upload artifacts instead of committing to the repo
      - name: Upload raw ingest (CSV)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: raw_games.csv
          path: out/raw_games.csv
          if-no-files-found: warn
          retention-days: 30

      - name: Upload prepared features (CSV)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mlb_features_prepared.csv
          path: out/mlb_features_prepared.csv
          if-no-files-found: warn
          retention-days: 30

      - name: Upload model outputs and report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: model_all_ts
          path: |
            model_all_ts/**
            model_all_ts/*.png
          if-no-files-found: warn
          retention-days: 30

      - name: Upload logs (helpful for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-and-metrics
          path: |
            model_all_ts/**/*.csv
            model_all_ts/**/*.txt
            out/**/*.txt
          if-no-files-found: warn
          retention-days: 14

      # Email notifications (uses your existing SMTP secrets)
      - name: Send success email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "✅ MLB pipeline SUCCESS — ${{ github.repository }} #${{ github.run_number }}"
          to: ${{ secrets.ALERT_TO }}
          from: ${{ secrets.ALERT_FROM }}
          secure: true
          html_body: |
            <h2>MLB pipeline run succeeded</h2>
            <ul>
              <li><b>Repo:</b> ${{ github.repository }}</li>
              <li><b>Run ID:</b> ${{ github.run_id }}</li>
              <li><b>Branch:</b> ${{ github.ref_name }}</li>
              <li><b>Commit:</b> ${{ github.sha }}</li>
              <li><b>Timestamp (UTC):</b> ${{ github.run_started_at }}</li>
            </ul>
            <p>Artifacts uploaded: raw_games.csv, mlb_features_prepared.csv, model_all_ts/</p>

      - name: Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "❌ MLB pipeline FAILED — ${{ github.repository }} #${{ github.run_number }}"
          to: ${{ secrets.ALERT_TO }}
          from: ${{ secrets.ALERT_FROM }}
          secure: true
          html_body: |
            <h2>MLB pipeline run failed</h2>
            <p>Check the run logs and downloaded artifacts (logs-and-metrics) for details.</p>
