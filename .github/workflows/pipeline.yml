name: MLB daily update & retrain

on:
  workflow_dispatch: {}
  schedule:
    - cron: "15 17 * * *"   # 09:15 AM Pacific (17:15 UTC)

permissions:
  contents: write

jobs:
  update-train:
    runs-on: ubuntu-latest
    timeout-minutes: 700

    steps:
      # 1) Checkout
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # 3) Deps
      - name: Install deps (try requirements.txt, else robust fallback)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip setuptools wheel

          FAILED_REQ=0
          if [[ -f requirements.txt ]]; then
            if ! pip install -r requirements.txt ; then
              FAILED_REQ=1
            fi
          else
            FAILED_REQ=1
          fi

          if [[ "$FAILED_REQ" = "1" ]]; then
            echo "Falling back to pinned Py3.11-safe versions"
            pip install --upgrade \
              "numpy<2.2" "pandas<2.3" "matplotlib>=3.8" \
              "scikit-learn>=1.4" "xgboost>=2.0" "lightgbm>=4.0" \
              "catboost>=1.2.5" "statsmodels>=0.14" "requests>=2.31" \
              "tqdm>=4.66" "pybaseball>=2.2.7" "MLB-StatsAPI>=1.7.1"
          else
            pip install --upgrade "MLB-StatsAPI>=1.7.1" || true
            pip install --upgrade "pybaseball>=2.2.7" || true
          fi

      # 4) Guard (only block legacy flag if it's on run_pipeline.py line)
      - name: Guard legacy flag only on run_pipeline.py
        shell: bash
        run: |
          set -euo pipefail
          echo "GITHUB_SHA: $GITHUB_SHA"
          echo "Branch: $GITHUB_REF_NAME"
          sed -n '140,220p' .github/workflows/pipeline.yml || true
          if grep -nE 'python[[:space:]]+scripts/run_pipeline\.py([^#\n]*)--backfill-days' .github/workflows/pipeline.yml; then
            echo "::error::Found legacy --backfill-days on run_pipeline.py invocation. Use --ingest-backfill-days/--feature-backfill-days/--max-update-days instead."
            exit 3
          fi
          echo "OK: no legacy --backfill-days on run_pipeline.py."
          python --version

      # 5) Seed/merge base → combined (first-run safe)
      - name: Seed or merge 2024 base into combined
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out

          # Try both locations for your 2024 base CSV
          CANDIDATES=(
            "out/mlb_features_full_20240328_to_20240929.csv"
            "out_backup/mlb_features_full_20240328_to_20240929.csv"
          )
          BASE_2024=""
          for p in "${CANDIDATES[@]}"; do
            if [[ -f "$p" ]]; then BASE_2024="$p"; break; fi
          done

          if [[ -z "${BASE_2024:-}" ]]; then
            echo "::warning::2024 base CSV not found in out/ or out_backup/. Continuing without base."
          elif [[ ! -f out/mlb_features_combined.csv ]]; then
            echo "Seeding combined from base: $BASE_2024"
            cp "$BASE_2024" out/mlb_features_combined.csv
          else
            echo "Merging base into existing combined from: $BASE_2024"
            python scripts/merge_base_into_combined.py "$BASE_2024" "out/mlb_features_combined.csv"
          fi

          # Ensure a minimal combined exists for later steps
          if [[ ! -f out/mlb_features_combined.csv ]]; then
            echo "[init] Creating empty combined as fallback"
            python -c "import pandas as pd; pd.DataFrame(columns=['game_date','game_pk','home_win']).to_csv('out/mlb_features_combined.csv', index=False)"
          fi

      # 6) Run orchestrator (incremental update on top of combined)
      - name: Run orchestrator (run_pipeline.py)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/run_pipeline.py \
            --pybin python \
            --base-year 2024 \
            --features-base "out/mlb_features_full_20240328_to_20240929.csv" \
            --features-combined "out/mlb_features_combined.csv" \
            --prepared "out/mlb_features_prepared.csv" \
            --model-out "model_all_ts" \
            --ingest-backfill-days 80 \
            --feature-backfill-days 80 \
            --max-update-days 80 \
            --run-eda \
            --add-rolling \
            --add-interactions

      # 7) Artifacts
      - name: Upload artifacts (reports + datasets)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mlb-artifacts
          if-no-files-found: warn
          retention-days: 14
          path: |
            out/**
            eda_out/**/*
            eda_out_plus/**/*
            model_out/**/*
            model_all_ts/**/*

      # 8) Commit any changes
      - name: Commit results (if changed)
        if: success()
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "CI: merge 2024 base + incremental update + retrain"
            git push
          fi

      # 9) Email on failure
      - name: Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "❌ MLB pipeline FAILED — ${{ github.repository }} #${{ github.run_number }} (main)"
          to: ${{ secrets.ALERT_TO }}
          from: ${{ secrets.ALERT_FROM }}
          secure: true
          html_body: |
            <h2>MLB pipeline run failed</h2>
            <ul>
              <li><b>Repo:</b> ${{ github.repository }}</li>
              <li><b>Run ID:</b> ${{ github.run_id }}</li>
              <li><b>Branch:</b> ${{ github.ref_name }}</li>
              <li><b>Commit:</b> ${{ github.sha }}</li>
              <li><b>Started (UTC):</b> ${{ github.run_started_at }}</li>
            </ul>
            <p>Check the run logs and downloaded artifacts (mlb-artifacts) for details.</p>




