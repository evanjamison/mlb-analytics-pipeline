name: MLB daily update & retrain

on:
  workflow_dispatch: {}           # enables manual "Run workflow" button
  schedule:
    - cron: "15 17 * * *"         # runs daily @ 09:15 AM Pacific (17:15 UTC)

permissions:
  contents: write

jobs:
  update-train:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      # -------------------------------
      # 1️⃣  Checkout repo
      # -------------------------------
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------
      # 2️⃣  Setup Python
      # -------------------------------
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # -------------------------------
      # 3️⃣  Install dependencies
      # -------------------------------
      - name: Install deps (try requirements.txt, else robust fallback)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip setuptools wheel

          FAILED_REQ=0
          if [[ -f "requirements.txt" ]]; then
            if ! pip install -r requirements.txt ; then
              FAILED_REQ=1
            fi
          else
            FAILED_REQ=1
          fi

          if [[ "$FAILED_REQ" = "1" ]]; then
            echo "⚙️ Falling back to pinned Py3.11-safe versions"
            pip install --upgrade \
              "numpy<2.2" "pandas<2.3" "matplotlib>=3.8" \
              "scikit-learn>=1.4" "xgboost>=2.0" "lightgbm>=4.0" \
              "catboost>=1.2.5" "statsmodels>=0.14" "requests>=2.31" \
              "tqdm>=4.66" \
              "pybaseball>=2.2.7" \
              "MLB-StatsAPI>=1.7.1"
          else
            pip install --upgrade "MLB-StatsAPI>=1.7.1" || true
            pip install --upgrade "pybaseball>=2.2.7" || true
          fi

      # -------------------------------
      # 4️⃣  Orchestrator (run_pipeline.py)
      # -------------------------------
      - name: Run orchestrator (run_pipeline.py) or fallback to manual build/train
        shell: bash
        run: |
          set -euo pipefail

          if [[ -f "scripts/run_pipeline.py" ]]; then
            echo ">> scripts/run_pipeline.py detected — running orchestrator"
            python scripts/run_pipeline.py \
              --pybin python \
              --base-year 2024 \
              --run-eda \
              --add-rolling \
              --add-interactions
          else
            echo ">> No orchestrator found — using manual build/train flow"
            mkdir -p out
            success=0

            # Try to build features using data_ingest
            if python scripts/data_ingest.py --year 2025 --backfill-days 35 --build-features --out out/mlb_features_prepared.csv 2>/dev/null; then
              success=1
            fi

            # Secondary fallback
            if [[ $success -eq 0 ]]; then
              if python scripts/data_ingest.py --year 2025 --backfill-days 35 --all --out out 2>/dev/null; then
                found="$(ls -1 out/mlb_features_*prepared*.csv 2>/dev/null | head -n1 || true)"
                if [[ -n "$found" ]]; then
                  cp "$found" out/mlb_features_prepared.csv
                  success=1
                fi
              fi
            fi

            # Hard fail if no dataset found
            if [[ $success -eq 0 ]]; then
              echo "❌ ERROR: No features CSV produced by data_ingest."
              exit 2
            fi

            # Train model
            python scripts/model_train_allinone.py \
              --data "out/mlb_features_prepared.csv" \
              --date-col game_date \
              --id-col game_pk \
              --target home_win \
              --outdir "model_all_ts" \
              --topk 25 \
              --threshold-strategy f1 \
              --add-rolling \
              --add-interactions \
              --calibration isotonic \
              --walkforward ts \
              --n-splits 6
          fi

      # -------------------------------
      # 5️⃣  Upload artifacts (datasets + reports)
      # -------------------------------
      - name: Upload artifacts (reports + datasets)
        uses: actions/upload-artifact@v4
        with:
          name: mlb-artifacts
          if-no-files-found: warn
          retention-days: 14
          path: |
            out/**
            eda_out/**/*
            eda_out_plus/**/*
            model_out/**/*
            model_all_ts/**/*

      # -------------------------------
      # 6️⃣  Commit results (if changed)
      # -------------------------------
      - name: Commit results (if changed)
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "CI: ingest + feature prep + retrain (auto)"
            git push
          fi

